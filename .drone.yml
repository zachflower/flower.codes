kind: pipeline
type: docker
name: default
trigger:
  branch:
    - main

steps:

- name: restore-cache
  image: drillster/drone-volume-cache
  volumes:
  - name: cache
    path: /cache
  settings:
    restore: true
    mount:
    - ./.bundle

- name: build
  image: ruby:2.7
  commands:
  - export BUNDLE_PATH="./.bundle"
  - bundle install
  - bundle exec jekyll build

- name: rebuild-cache
  image: drillster/drone-volume-cache
  volumes:
  - name: cache
    path: /cache
  settings:
    rebuild: true
    mount:
    - ./.bundle

- name: optimize
  image: ruby:2.7
  commands:
  - apt update
  - apt install imagemagick -y

  # compress png images
  - mogrify -verbose -colorspace Gray -colors 4 -quality 10 /drone/src/_site/assets/posts/*.png

  # resize large png images
  - identify -format '%w %h %i\n' /drone/src/_site/assets/posts*.png | awk '$1 > 800 || $2 > 800 {sub(/^[^ ]* [^ ]* /, ""); print}' | tr '\n' '\0' | xargs -0 mogrify -resize '800'

  # compress jpg images
  - mogrify -verbose -colorspace Gray -colors 4 -quality 10 /drone/src/_site/assets/posts/*.jpg

  # resize large jpg images
  - identify -format '%w %h %i\n' /drone/src/_site/assets/posts*.jpg | awk '$1 > 800 || $2 > 800 {sub(/^[^ ]* [^ ]* /, ""); print}' | tr '\n' '\0' | xargs -0 mogrify -resize '800'

- name: deploy
  image: ruby:2.7
  commands:
  - apt update
  - apt install rsync -y
  - eval `ssh-agent -s`
  - echo "$RSYNC_KEY" | ssh-add -
  - mkdir -p ~/.ssh
  - echo "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  - rsync -rvc /drone/src/_site/ $RSYNC_USER@$RSYNC_HOST:/var/www/flower.codes/
  environment:
    RSYNC_KEY:
      from_secret: rsync_key
    RSYNC_USER:
      from_secret: rsync_user
    RSYNC_HOST:
      from_secret: rsync_host

volumes:
  - name: cache
    host:
      path: /tmp/cache